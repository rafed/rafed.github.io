<!DOCTYPE html>
<html>
<head>
	<title>BSSE 7th Batch Repo</title>
	<meta charset='utf-8' />
	
	<style>
		a:hover {
			cursor: pointer;
			text-decoration: underline;
		}
	</style>
</head>

<body>
	<h2>Download files</h2>
	
	<input type="button" value="Home" onclick="goHome()"/>
	<input type="button" value="Back" onclick="goBack()"/>
	
	<div>
		<h3 id='parent'></h3>
		<table id='fileList'>
		</table>
	</div>
	
	<script async src='download.js'></script>
	<script>
	
		const CLIENT_ID = '226558469156-4glaf1k4834m2aok0ogohvcck8tom682.apps.googleusercontent.com';
		// const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
		// const SCOPES = 'https://www.googleapis.com/auth/drive';
		const REFRESH_TOKEN = "1/hiNx4ii2jzcWj7rZybwIxTlZC6Hy3sOlRgO92gMQn44";
		const CLIENT_SECRET = "g0xby1C5zhLRNkn3CtnGObR_";
		const REFRESH_TOKEN_URL = "https://www.googleapis.com/oauth2/v4/token";
	
		var accessToken;
		var homeFolderId;
		var homeFolder = 'BSSE 3-1 ';
		
		var folderArray = [];
	
		function getAccessToken() {
			const post_body = `grant_type=refresh_token&client_id=${encodeURIComponent(CLIENT_ID)}` +
							  `&client_secret=${encodeURIComponent(CLIENT_SECRET)}` +
							  `&refresh_token=${encodeURIComponent(REFRESH_TOKEN)}`;

			let refresh_request = {
				body: post_body,
				method: "POST",
				headers: new Headers({
				    'Content-Type': 'application/x-www-form-urlencoded'
				})
			}

			fetch(REFRESH_TOKEN_URL, refresh_request)
			.then(response => {
				return response.json();
			})
			.then( response_json =>  {
			 	console.log(response_json);
			    accessToken = response_json.access_token;
				return response_json.access_token;			    
			})
			.then(token => {
				return getHomeFolderId();
			})
			.then(folderId => {
				listFiles(folderId);
			})
		}
			

		function getHomeFolderId(){
			var url = `https://www.googleapis.com/drive/v3/files?q=name='${homeFolder}' and starred=true` + 
					  `&orderBy=folder,createdTime&pageSize=1000`;
					  
			let drive_request = {
				method: "GET",
				headers: new Headers({
				    Authorization: "Bearer " + accessToken
				})
			}
			
			return fetch(url, drive_request).then( response => {
				return(response.json());
			}).then( list =>  {
				return list.files[0].id;		
			}).then(id => {
				homeFolderId = id;
				return id;
			});
		}

		function goHome(){
			if(folderArray.length > 1){
				folderArray = [];
				listFiles(homeFolderId);
			}
		}

		function goBack(){
			if(folderArray.length > 1){
				var temp = folderArray[folderArray.length-2];
				
				folderArray.pop();
				folderArray.pop();
				
				listFiles(temp);
			}
		}

		function listFiles(folderId) {
			folderArray.push(folderId);
		
			var drive_url = `https://www.googleapis.com/drive/v3/files?q='${folderId}' in parents` +
							`&orderBy=folder,name&pageSize=1000`;

			let drive_request = {
				method: "GET",
				headers: new Headers({
				    Authorization: "Bearer " + accessToken
				})
			}
			
			var table = document.getElementById('fileList');
			while (table.hasChildNodes()) {
				table.removeChild(table.lastChild);
			}
			
			fetch(drive_url, drive_request).then( response => {
				return(response.json());
			}).then(list =>  {
				
				for(var i=0; i<list.files.length; i++){
					var tr = document.createElement("tr");
					var td1 = document.createElement("td");
					var td2 = document.createElement("td");
					
					var a1 = document.createElement("a");
					var a2 = document.createElement("a");
					
					a1.appendChild(document.createTextNode(list.files[i].name + ' --- ' + list.files[i].mimeType));
					a1.setAttribute('data-id', list.files[i].id);
					a1.setAttribute('data-name', list.files[i].name);
					a1.setAttribute('data-type', list.files[i].mimeType);
					
					if(list.files[i].mimeType === 'application/vnd.google-apps.folder'){ // if folder
						a1.setAttribute('onclick', 'listFiles(this.dataset.id)');
					}
					else{
						a1.setAttribute('onclick', 'downloadFile(this.dataset.id, this.dataset.name, this.dataset.type)');
					}
					
					a2.appendChild(document.createTextNode('Download'));
					a2.setAttribute('data-id', list.files[i].id);
					a2.setAttribute('data-name', list.files[i].name);
					a2.setAttribute('data-type', list.files[i].mimeType);
					a2.setAttribute('onclick', 'downloadFile(this.dataset.id, this.dataset.name, this.dataset.type)');
					
					td1.appendChild(a1);
					td2.appendChild(a2);
					
					tr.appendChild(td1);
					tr.appendChild(td2);
					
					table.appendChild(tr);
				}
			});
		}
		
		function downloadFile(fileId, fileName, fileType){
			var url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
					  
			let drive_request = {
				method: "GET",
				headers: new Headers({
				    Authorization: "Bearer " + accessToken
				})
			}
			
			fetch(url, drive_request)
			.then(function(resp) {
				return resp.blob();
			}).then(function(blob) {
				download(blob, fileName, fileType);
  			});
		}
		
		getAccessToken();
	</script>
	
</body>
</html>
